<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>APPS Education | Management System</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for Reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; -webkit-tap-highlight-color: transparent; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Print Styles */
        @media print {
            @page { size: A4; margin: 0; }
            body * { visibility: hidden; }
            #printable-area, #printable-area * { visibility: visible; }
            #printable-area { 
                position: absolute; left: 0; top: 0; width: 100%; 
                background: white; min-height: 100vh;
            }
            .no-print { display: none !important; }
            .a4-page { width: 210mm; min-height: 297mm; padding: 20mm; margin: 0 auto; background: white; box-sizing: border-box; }
        }

        /* Glassmorphism */
        .id-card-bg {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            position: relative; overflow: hidden;
        }
        .id-card-bg::before {
            content: ''; position: absolute; top: -50px; right: -50px; width: 150px; height: 150px;
            background: rgba(255,255,255,0.1); border-radius: 50%;
        }

        /* Animations */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Marquee */
        .marquee-container { overflow: hidden; white-space: nowrap; }
        .marquee-content { display: inline-block; animation: marquee 30s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
    </style>
</head>
<body class="text-slate-800 pb-8"> <!-- Added pb-8 to prevent content being hidden behind footer -->

    <!-- Notifications -->
    <div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-2 pointer-events-none"></div>

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-900 to-slate-900 p-4 pb-12">
        <div class="bg-white rounded-2xl shadow-2xl flex overflow-hidden max-w-4xl w-full fade-in flex-col md:flex-row">
            <div class="hidden md:block w-1/2 bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1523050854058-8df90110c9f1?ixlib=rb-1.2.1&auto=format&fit=crop&w=1350&q=80');">
                <div class="h-full w-full bg-blue-900 bg-opacity-60 flex flex-col justify-center items-center text-white p-8">
                    <!-- Logo on Desktop Login Panel -->
                    <img src="logo.png" alt="Logo" class="w-24 h-24 mb-4 object-contain drop-shadow-md" onerror="this.style.display='none'; document.getElementById('desktop-fallback-icon').style.display='block'">
                    <i id="desktop-fallback-icon" class="fas fa-graduation-cap text-6xl mb-4 hidden"></i>
                    
                    <h1 class="text-4xl font-bold mb-4">APPS Education</h1>
                    <p class="text-lg text-center">Empowering minds, shaping futures.</p>
                </div>
            </div>
            <div class="w-full md:w-1/2 p-8 md:p-12">
                <div class="md:hidden text-center mb-6 flex flex-col items-center">
                    <!-- Logo on Mobile Login Header -->
                    <img src="logo.png" alt="Logo" class="w-16 h-16 mb-2 object-contain" onerror="this.style.display='none'; document.getElementById('mobile-fallback-icon').style.display='block'">
                    <i id="mobile-fallback-icon" class="fas fa-graduation-cap text-4xl text-blue-900 mb-2 hidden"></i>
                    
                    <h1 class="text-3xl font-bold text-blue-900">APPS Education</h1>
                </div>
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Welcome Back</h2>
                <p class="text-slate-500 mb-8">Please login to your account</p>
                
                <form id="login-form" onsubmit="handleLogin(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Email ID</label>
                        <input type="email" id="username" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:outline-none transition" placeholder="Enter your email" required>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-700 mb-1">Password</label>
                        <input type="password" id="password" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:outline-none transition" placeholder="Enter password" required>
                        <div class="text-right mt-2">
                            <button type="button" onclick="forgotPassword()" class="text-sm text-blue-600 hover:text-blue-800 hover:underline">Forgot Password?</button>
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition shadow-lg transform hover:scale-[1.02]">Login</button>
                    
                    <div class="mt-6 text-center space-y-2">
                         <div>
                            <button type="button" onclick="exportDatabase()" class="text-xs text-blue-500 hover:text-blue-700 border-b border-blue-300 mr-4"><i class="fas fa-download"></i> Backup Data</button>
                            <label class="text-xs text-blue-500 hover:text-blue-700 border-b border-blue-300 cursor-pointer">
                                <i class="fas fa-upload"></i> Restore Data
                                <input type="file" class="hidden" onchange="importDatabase(this)" accept=".json">
                            </label>
                        </div>
                        <div>
                            <button type="button" onclick="hardReset()" class="text-xs text-red-400 hover:text-red-600 border-b border-red-300">Reset App Data (Fix Login)</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Layout (Hidden by default) -->
    <div id="dashboard-layout" class="hidden min-h-screen flex">
        
        <!-- Sidebar -->
        <aside id="sidebar" class="bg-slate-900 text-white w-64 flex-shrink-0 hidden md:flex flex-col transition-all duration-300 fixed md:relative h-full z-40 shadow-xl">
            <div class="p-6 border-b border-slate-700">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-3">
                        <!-- Logo on Sidebar -->
                        <img src="logo.png" alt="Logo" class="w-8 h-8 object-contain bg-white rounded-full p-0.5" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                        <i class="fas fa-graduation-cap text-xl hidden"></i>
                        <span class="text-xl font-bold tracking-wider">APPS Edu</span>
                    </div>
                    <button onclick="toggleSidebar()" class="md:hidden text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
                </div>
                <!-- Dynamic Teacher Phone Display -->
                <div id="teacher-contact-display" class="text-xs text-slate-400 hidden mt-2 p-2 bg-slate-800 rounded">
                    <i class="fas fa-phone-alt mr-1 text-green-400"></i> <span id="teacher-phone-val"></span>
                </div>
            </div>
            
            <nav class="flex-1 overflow-y-auto py-4">
                <ul class="space-y-1 px-3" id="nav-menu">
                    <!-- Nav items injected via JS based on Role -->
                </ul>
            </nav>

            <div class="p-4 border-t border-slate-700">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center font-bold text-lg" id="user-avatar">A</div>
                    <div class="flex-1 overflow-hidden">
                        <p class="text-sm font-semibold truncate" id="user-name-display">User</p>
                        <p class="text-xs text-slate-400 capitalize" id="user-role-display">Role</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-2 mt-4">
                    <button onclick="openModal('changePassword')" class="flex items-center justify-center gap-2 bg-slate-800 hover:bg-slate-700 py-2 rounded text-xs transition text-slate-300" title="Change Password">
                        <i class="fas fa-key"></i> Pass
                    </button>
                    <button onclick="logout()" class="flex items-center justify-center gap-2 bg-red-900/30 hover:bg-red-900/50 text-red-200 py-2 rounded text-xs transition">
                        <i class="fas fa-sign-out-alt"></i> Out
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
            <!-- Mobile Header -->
            <header class="bg-white shadow-sm flex flex-col z-30 sticky top-0">
                <!-- Highlighted Notification Bar -->
                <div class="bg-gradient-to-r from-yellow-100 to-yellow-50 border-b border-yellow-200 text-yellow-800 h-8 flex items-center px-4 overflow-hidden relative">
                    <div class="text-xs font-bold bg-yellow-200 px-2 py-0.5 rounded mr-2 z-10 shadow-sm whitespace-nowrap">NOTICE</div>
                    <div class="marquee-container flex-1">
                        <div class="marquee-content text-sm font-medium" id="marquee-text">
                            <!-- Injected via JS -->
                        </div>
                    </div>
                </div>

                <div class="h-16 flex items-center justify-between px-4 md:px-8 gap-4">
                    <div class="flex items-center gap-2 flex-1 md:flex-none">
                        <button onclick="toggleSidebar()" class="md:hidden text-slate-600 text-xl p-2"><i class="fas fa-bars"></i></button>
                        <h2 id="page-title" class="text-xl font-bold text-slate-800 hidden md:block">Dashboard</h2>
                    </div>

                    <!-- Global Search Bar (Admin Only) -->
                    <div id="global-search-container" class="flex-1 max-w-md hidden w-full">
                        <div class="relative">
                            <input type="text" id="global-search-input" onkeyup="performSearch(this.value)" placeholder="Search..." class="w-full bg-gray-100 border-none rounded-full py-2 px-4 pl-10 focus:ring-2 focus:ring-blue-500 focus:bg-white transition text-sm">
                            <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
                        </div>
                    </div>

                    <div class="flex items-center gap-2">
                         <button class="relative text-slate-500 hover:text-blue-600 p-2 md:hidden" onclick="openModal('changePassword')">
                            <i class="fas fa-key text-xl"></i>
                        </button>
                        <button class="relative text-slate-500 hover:text-blue-600 p-2" onclick="showNotifications()">
                            <i class="fas fa-bell text-xl"></i>
                            <span id="notif-badge" class="absolute top-1 right-1 w-4 h-4 bg-red-500 rounded-full text-[10px] text-white flex items-center justify-center hidden">0</span>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Dynamic Content Area -->
            <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8 relative">
                <!-- Views injected here -->
            </div>
        </main>
        
        <!-- Mobile Sidebar Overlay -->
        <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
    </div>

    <!-- Modals Container -->
    <div id="modal-container" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm p-4">
        <!-- Modal content injected via JS -->
    </div>

    <!-- Copyright Footer -->
    <div class="fixed bottom-0 left-0 w-full text-center text-[10px] text-gray-400 bg-[#f3f4f6] py-2 z-50 border-t border-gray-200">
        Â© APPS Education, Buldhana. 9960690690
    </div>

    <script>
        // ==========================================
        // DATA STORE & MOCK BACKEND
        // ==========================================
        
        const DB_KEYS = {
            USERS: 'apps_users',
            STUDENTS: 'apps_students',
            BATCHES: 'apps_batches',
            ATTENDANCE: 'apps_attendance',
            MARKS: 'apps_marks',
            FEES: 'apps_fees',
            NOTICES: 'apps_notices',
            CURRENT_USER: 'apps_current_session'
        };

        // Initialize Data if Empty (ONLY ADMIN INITIALLY)
        function initDB() {
            // 1. Load existing users or start empty
            let users = JSON.parse(localStorage.getItem(DB_KEYS.USERS) || '[]');
            
            // 2. Ensure Admin Exists
            const adminExists = users.some(u => u.role === 'admin');
            if (!adminExists) {
                 users.push({ 
                    id: 'u1', 
                    name: 'Super Admin', 
                    username: 'admin@apps.edu', 
                    password: 'admin', 
                    role: 'admin', 
                    dob: '1980-01-01' 
                });
            }

            // 3. Save back to storage
            localStorage.setItem(DB_KEYS.USERS, JSON.stringify(users));

            if (!localStorage.getItem(DB_KEYS.BATCHES)) {
                localStorage.setItem(DB_KEYS.BATCHES, JSON.stringify([]));
            }
            if (!localStorage.getItem(DB_KEYS.STUDENTS)) {
                localStorage.setItem(DB_KEYS.STUDENTS, JSON.stringify([]));
            }
            if (!localStorage.getItem(DB_KEYS.ATTENDANCE)) {
                localStorage.setItem(DB_KEYS.ATTENDANCE, JSON.stringify([]));
            }
            if (!localStorage.getItem(DB_KEYS.MARKS)) {
                localStorage.setItem(DB_KEYS.MARKS, JSON.stringify([]));
            }
            if (!localStorage.getItem(DB_KEYS.NOTICES)) {
                localStorage.setItem(DB_KEYS.NOTICES, JSON.stringify([]));
            }
        }

        const DAO = {
            get: (key) => JSON.parse(localStorage.getItem(key) || '[]'),
            set: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
            findUsersByCreds: (username, password) => {
                const users = DAO.get(DB_KEYS.USERS);
                // Trim inputs just in case
                return users.filter(u => u.username === username.trim() && u.password === password.trim());
            },
            getStudentsByBatch: (batchId) => {
                return DAO.get(DB_KEYS.STUDENTS).filter(s => s.batchId === batchId);
            },
            getWards: (parentId) => {
                return DAO.get(DB_KEYS.STUDENTS).filter(s => s.parentId === parentId);
            }
        };

        let currentUser = null;
        let currentChart = null;
        let selectedWardId = null;

        // ==========================================
        // APP LOGIC
        // ==========================================

        function initApp() {
            initDB();
            setTimeout(() => {
                updateMarquee();
                const savedSession = sessionStorage.getItem(DB_KEYS.CURRENT_USER);
                if (savedSession) {
                    currentUser = JSON.parse(savedSession);
                    showDashboard();
                } else {
                    document.getElementById('login-screen').classList.remove('hidden');
                    document.getElementById('dashboard-layout').classList.add('hidden');
                }
            }, 50);
        }

        // --- NEW BACKUP & RESTORE FUNCTIONS ---
        function exportDatabase() {
            const data = {
                users: DAO.get(DB_KEYS.USERS),
                students: DAO.get(DB_KEYS.STUDENTS),
                batches: DAO.get(DB_KEYS.BATCHES),
                attendance: DAO.get(DB_KEYS.ATTENDANCE),
                marks: DAO.get(DB_KEYS.MARKS),
                fees: DAO.get(DB_KEYS.FEES),
                notices: DAO.get(DB_KEYS.NOTICES)
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'apps_database_backup.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showToast('Database backup downloaded!', 'success');
        }

        function importDatabase(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.users && data.students) {
                        localStorage.setItem(DB_KEYS.USERS, JSON.stringify(data.users));
                        localStorage.setItem(DB_KEYS.STUDENTS, JSON.stringify(data.students));
                        localStorage.setItem(DB_KEYS.BATCHES, JSON.stringify(data.batches || []));
                        localStorage.setItem(DB_KEYS.ATTENDANCE, JSON.stringify(data.attendance || []));
                        localStorage.setItem(DB_KEYS.MARKS, JSON.stringify(data.marks || []));
                        localStorage.setItem(DB_KEYS.FEES, JSON.stringify(data.fees || []));
                        localStorage.setItem(DB_KEYS.NOTICES, JSON.stringify(data.notices || []));
                        alert('Data restored successfully! The page will reload.');
                        window.location.reload();
                    } else {
                        alert('Invalid backup file structure.');
                    }
                } catch (err) {
                    alert('Error reading file: ' + err.message);
                }
            };
            reader.readAsText(file);
        }

        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();
            const matchedUsers = DAO.findUsersByCreds(u, p);

            if (matchedUsers.length === 1) {
                finalizeLogin(matchedUsers[0]);
            } else if (matchedUsers.length > 1) {
                showAccountSelection(matchedUsers);
            } else {
                showToast('Invalid credentials', 'error');
            }
        }

        function hardReset() {
            if(confirm('This will delete ALL data and restore the default admin account. Continue?')) {
                localStorage.clear();
                sessionStorage.clear();
                window.location.reload();
            }
        }

        function showAccountSelection(users) {
            const modal = document.getElementById('modal-container');
            modal.classList.remove('hidden');
            const buttons = users.map(user => `
                <button onclick='finalizeLogin(${JSON.stringify(user)})' class="w-full bg-slate-50 hover:bg-slate-100 border border-slate-200 text-slate-800 p-4 rounded-lg flex items-center gap-4 transition text-left">
                    <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold">
                        ${user.role.charAt(0).toUpperCase()}
                    </div>
                    <div>
                        <p class="font-bold capitalize">${user.name}</p>
                        <p class="text-xs text-gray-500 uppercase">${user.role}</p>
                    </div>
                    <i class="fas fa-chevron-right ml-auto text-gray-300"></i>
                </button>
            `).join('');
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 w-full max-w-sm">
                    <h3 class="text-xl font-bold mb-2">Select Account</h3>
                    <div class="space-y-3">${buttons}</div>
                    <button onclick="closeModal()" class="mt-4 w-full text-center text-gray-500 text-sm hover:text-gray-800">Cancel</button>
                </div>
            `;
        }

        function finalizeLogin(user) {
            currentUser = user;
            sessionStorage.setItem(DB_KEYS.CURRENT_USER, JSON.stringify(user));
            closeModal();
            
            if (currentUser.role === 'parent') {
                const wards = DAO.getWards(currentUser.id);
                if (wards.length > 0) selectedWardId = wards[0].id;
            }

            showToast(`Welcome, ${user.name}`, 'success');
            showDashboard();
        }

        function logout() {
            currentUser = null;
            selectedWardId = null;
            sessionStorage.removeItem(DB_KEYS.CURRENT_USER);
            window.location.reload();
        }

        function showDashboard() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard-layout').classList.remove('hidden');
            
            const searchContainer = document.getElementById('global-search-container');
            if (currentUser.role === 'admin') {
                searchContainer.classList.remove('hidden');
            } else {
                searchContainer.classList.add('hidden');
            }

            document.getElementById('user-name-display').innerText = currentUser.name;
            document.getElementById('user-role-display').innerText = currentUser.role;
            document.getElementById('user-avatar').innerText = currentUser.name.charAt(0);

            updateTeacherContact();
            renderNav();
            
            if (currentUser.role === 'parent') {
                renderView('my-child');
            } else {
                renderView('dashboard');
            }
        }

        function updateTeacherContact() {
            const display = document.getElementById('teacher-contact-display');
            const val = document.getElementById('teacher-phone-val');
            
            if (currentUser.role === 'parent' && selectedWardId) {
                const student = DAO.get(DB_KEYS.STUDENTS).find(s => s.id === selectedWardId);
                if (student) {
                    const batch = DAO.get(DB_KEYS.BATCHES).find(b => b.id === student.batchId);
                    if (batch && batch.teacherId) {
                        const teacher = DAO.get(DB_KEYS.USERS).find(u => u.id === batch.teacherId);
                        if (teacher && teacher.phone) {
                            val.innerText = teacher.phone;
                            display.classList.remove('hidden');
                            return;
                        }
                    }
                }
            }
            display.classList.add('hidden');
        }

        function switchWard(wardId) {
            selectedWardId = wardId;
            updateTeacherContact();
            renderView('my-child'); 
        }

        function updateMarquee() {
            const notices = DAO.get(DB_KEYS.NOTICES).reverse().slice(0, 5); 
            const marquee = document.getElementById('marquee-text');
            if (!marquee) return;
            
            if (!notices.length) {
                marquee.innerHTML = "Welcome to APPS Education Management System. Please stay tuned for updates.";
                return;
            }
            marquee.innerHTML = notices.map(n => `<span class="mx-4">ðŸ“¢ ${n.title}: ${n.message}</span>`).join(' â€¢ ');
        }

        function renderNav() {
            const nav = document.getElementById('nav-menu');
            nav.innerHTML = '';
            const createItem = (id, icon, text, onclick) => `
                <li><button onclick="${onclick}" class="w-full flex items-center gap-3 px-3 py-3 rounded-lg text-slate-300 hover:bg-slate-800 hover:text-white transition group text-left">
                    <i class="${icon} w-6 text-center group-hover:text-blue-400"></i><span class="text-sm font-medium">${text}</span>
                </button></li>`;

            if (currentUser.role === 'admin') {
                nav.innerHTML += createItem('nav-dash', 'fas fa-th-large', 'Dashboard', "renderView('dashboard')");
                nav.innerHTML += createItem('nav-not', 'fas fa-bullhorn', 'Notices', "renderView('notices')");
                nav.innerHTML += createItem('nav-stu', 'fas fa-user-graduate', 'Students', "renderView('students')");
                nav.innerHTML += createItem('nav-bat', 'fas fa-chalkboard', 'Batches', "renderView('batches')");
                nav.innerHTML += createItem('nav-tea', 'fas fa-chalkboard-teacher', 'Teachers', "renderView('teachers')");
                nav.innerHTML += createItem('nav-fee', 'fas fa-rupee-sign', 'Fees', "renderView('fees')");
            } else if (currentUser.role === 'teacher') {
                nav.innerHTML += createItem('nav-dash', 'fas fa-th-large', 'Dashboard', "renderView('dashboard')");
                nav.innerHTML += createItem('nav-not', 'fas fa-bullhorn', 'Notices', "renderView('notices')");
                nav.innerHTML += createItem('nav-att', 'fas fa-calendar-check', 'Attendance', "renderView('attendance')");
                nav.innerHTML += createItem('nav-mark', 'fas fa-poll', 'Marks & Achievements', "renderView('marks')");
                nav.innerHTML += createItem('nav-fee', 'fas fa-rupee-sign', 'Student Fees', "renderView('fees')");
            } else if (currentUser.role === 'parent') {
                nav.innerHTML += createItem('nav-child', 'fas fa-child', 'My Ward', "renderView('my-child')");
                nav.innerHTML += createItem('nav-not', 'fas fa-bullhorn', 'Notices', "renderView('notices')");
                nav.innerHTML += createItem('nav-att-rep', 'fas fa-calendar-alt', 'Attendance Report', "renderView('parent-attendance')");
            }
        }

        function renderView(viewName) {
            const content = document.getElementById('content-area');
            const title = document.getElementById('page-title');
            
            if(viewName !== 'search-results') {
                const searchInput = document.getElementById('global-search-input');
                if(searchInput) searchInput.value = '';
            }
            if(window.innerWidth < 768) {
                document.getElementById('sidebar').classList.add('hidden');
                document.getElementById('sidebar-overlay').classList.add('hidden');
            }

            content.innerHTML = '<div class="flex items-center justify-center h-full"><i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i></div>';

            setTimeout(() => {
                switch(viewName) {
                    case 'dashboard': title.innerText = 'Dashboard'; content.innerHTML = getDashboardHTML(); break;
                    case 'notices': title.innerText = 'Notices Board'; content.innerHTML = getNoticesHTML(); break;
                    case 'students': title.innerText = 'Students'; content.innerHTML = getStudentsHTML(); break;
                    case 'batches': title.innerText = 'Batches'; content.innerHTML = getBatchesHTML(); break;
                    case 'attendance': title.innerText = 'Mark Attendance'; content.innerHTML = getAttendanceHTML(); break;
                    case 'marks': title.innerText = 'Achievements'; content.innerHTML = getMarksHTML(); break;
                    case 'my-child': title.innerText = 'My Ward'; content.innerHTML = getMyChildHTML(); break;
                    case 'parent-attendance': title.innerText = 'Attendance Report'; content.innerHTML = getParentAttendanceHTML(); break;
                    case 'fees': title.innerText = 'Fees'; content.innerHTML = getFeesHTML(); break;
                    case 'teachers': title.innerText = 'Teachers'; content.innerHTML = getTeachersHTML(); break;
                    case 'search-results': title.innerText = 'Search Results'; break;
                    default: content.innerHTML = '<p>View not found.</p>';
                }
            }, 200);
        }

        // --- Helpers ---
        function getWardSwitcherHTML() {
            if (currentUser.role !== 'parent') return '';
            const wards = DAO.getWards(currentUser.id);
            if (wards.length < 2) return ''; 

            return `
                <div class="mb-4 flex justify-end">
                    <div class="bg-white border rounded-lg p-1 flex items-center shadow-sm">
                        <span class="text-xs font-bold text-gray-500 px-2 uppercase">Switch Ward:</span>
                        <select onchange="switchWard(this.value)" class="bg-transparent text-sm font-bold text-blue-600 outline-none cursor-pointer">
                            ${wards.map(w => `<option value="${w.id}" ${w.id === selectedWardId ? 'selected' : ''}>${w.name}</option>`).join('')}
                        </select>
                    </div>
                </div>
            `;
        }

        // --- HTML Generators ---

        function getDashboardHTML() {
            const students = DAO.get(DB_KEYS.STUDENTS);
            const batches = DAO.get(DB_KEYS.BATCHES);
            const teachers = DAO.get(DB_KEYS.USERS).filter(u => u.role === 'teacher');
            
            const card = (title, val, color, icon) => `
                <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 ${color}">
                    <div class="flex justify-between items-center">
                        <div><p class="text-sm text-gray-500 font-medium">${title}</p><h3 class="text-3xl font-bold text-slate-800 mt-1">${val}</h3></div>
                        <div class="w-12 h-12 rounded-full bg-slate-100 flex items-center justify-center text-xl text-slate-600"><i class="${icon}"></i></div>
                    </div>
                </div>
            `;

            return `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    ${card('Total Students', students.length, 'border-blue-500', 'fas fa-user-graduate')}
                    ${card('Active Batches', batches.length, 'border-green-500', 'fas fa-layer-group')}
                    ${card('Teachers', teachers.length, 'border-purple-500', 'fas fa-chalkboard-teacher')}
                    ${card('Pending Fees', 'â‚¹ 0', 'border-red-500', 'fas fa-wallet')}
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm"><h3 class="font-bold text-lg mb-4">Quick Actions</h3><div class="grid grid-cols-2 gap-4"><button onclick="openModal('addStudent')" class="p-4 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition flex flex-col items-center gap-2"><i class="fas fa-plus-circle text-2xl"></i> <span class="text-sm font-medium">Add Student</span></button><button onclick="renderView('batches')" class="p-4 bg-purple-50 text-purple-600 rounded-lg hover:bg-purple-100 transition flex flex-col items-center gap-2"><i class="fas fa-clock text-2xl"></i> <span class="text-sm font-medium">Manage Schedule</span></button></div></div>
                    <div class="bg-white p-6 rounded-xl shadow-sm"><h3 class="font-bold text-lg mb-4">Recent Updates</h3><p class="text-sm text-gray-500">System is ready to start.</p></div>
                </div>
            `;
        }

        function getMyChildHTML() {
            if (!selectedWardId) return '<p class="text-center text-gray-500 mt-10">No wards linked to this account.</p>';
            const student = DAO.get(DB_KEYS.STUDENTS).find(s => s.id === selectedWardId);
            if (!student) return '<p>Student data not found.</p>';

            const allTests = DAO.get(DB_KEYS.MARKS);
            const myResults = allTests.filter(t => t.scores && t.scores[student.id]).map(t => ({
                name: t.name, date: t.date, max: t.maxMarks, score: parseInt(t.scores[student.id]),
                percentage: (parseInt(t.scores[student.id]) / t.maxMarks * 100).toFixed(1)
            })).sort((a,b) => new Date(b.date) - new Date(a.date));

            const totalScore = myResults.reduce((sum, r) => sum + r.score, 0);
            const totalMax = myResults.reduce((sum, r) => sum + r.max, 0);
            const overallPerc = totalMax > 0 ? ((totalScore / totalMax) * 100).toFixed(1) : 0;
            let analysisText = "No data available.", analysisColor = "text-gray-500";
            if(myResults.length > 0) {
                if(overallPerc >= 80) { analysisText = "Excellent Performance!"; analysisColor = "text-green-600"; } 
                else if(overallPerc >= 60) { analysisText = "Good Performance."; analysisColor = "text-blue-600"; } 
                else { analysisText = "Needs Improvement."; analysisColor = "text-orange-500"; }
            }

            const rows = myResults.map(r => `
                <tr class="border-b hover:bg-gray-50"><td class="p-3 whitespace-nowrap"><div class="font-medium text-slate-800">${r.name}</div><div class="text-xs text-gray-500">${r.date}</div></td><td class="p-3 text-center">${r.max}</td><td class="p-3 text-center font-bold">${r.score}</td><td class="p-3 text-right"><span class="px-2 py-1 rounded text-xs font-bold ${r.percentage >= 75 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${r.percentage}%</span></td></tr>
            `).join('');

            return `
                <div class="max-w-4xl mx-auto space-y-6 pb-20">
                    ${getWardSwitcherHTML()}
                    <div class="bg-white rounded-xl shadow-sm p-6 flex flex-col md:flex-row items-center gap-6">
                        <div class="w-24 h-24 rounded-full bg-blue-100 flex items-center justify-center text-4xl text-blue-500 overflow-hidden border-4 border-white shadow">${student.photo ? `<img src="${student.photo}" class="w-full h-full object-cover">` : '<i class="fas fa-user"></i>'}</div>
                        <div class="flex-1 text-center md:text-left"><h2 class="text-2xl font-bold text-slate-800">${student.name}</h2><p class="text-gray-500">Batch: ${student.batchId} | ID: ${student.id}</p><div class="mt-4 flex gap-3 justify-center md:justify-start"><label class="bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg cursor-pointer text-sm font-medium transition"><i class="fas fa-camera mr-2"></i> Update Photo<input type="file" class="hidden" accept="image/*" onchange="uploadPhoto(this, '${student.id}')"></label></div></div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl shadow-sm p-6"><h3 class="font-bold text-lg mb-4">Performance Trend</h3><canvas id="performanceChart" height="200"></canvas></div>
                        <div class="bg-white rounded-xl shadow-sm p-6 flex flex-col"><h3 class="font-bold text-lg mb-2">Performance Analysis</h3><div class="flex-1 bg-gray-50 rounded-lg p-4 mb-4 border border-gray-100"><p class="text-sm font-medium text-gray-500 uppercase mb-1">Overall Assessment</p><p class="text-lg font-bold ${analysisColor}">${analysisText}</p><div class="mt-4 grid grid-cols-2 gap-4"><div><p class="text-xs text-gray-400">Tests Taken</p><p class="font-bold text-xl">${myResults.length}</p></div><div><p class="text-xs text-gray-400">Avg. Percentage</p><p class="font-bold text-xl">${overallPerc}%</p></div></div></div></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden"><div class="p-4 border-b bg-gray-50"><h3 class="font-bold text-lg">Test Results History</h3></div><div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-gray-100 text-gray-500 text-xs uppercase"><tr><th class="p-3">Test</th><th class="p-3 text-center">Max</th><th class="p-3 text-center">Score</th><th class="p-3 text-right">Result</th></tr></thead><tbody>${rows || '<tr><td colspan="4" class="p-6 text-center text-gray-400 italic">No results available.</td></tr>'}</tbody></table></div></div>
                </div>
            `;
        }

        function getParentAttendanceHTML() {
            if (!selectedWardId) return '<p>No student selected.</p>';
            const attendanceData = DAO.get(DB_KEYS.ATTENDANCE);
            const myRecords = attendanceData.map(record => {
                if(record.records && record.records[selectedWardId]) return { date: record.date, status: record.records[selectedWardId] };
                return null;
            }).filter(item => item !== null).sort((a, b) => new Date(b.date) - new Date(a.date));

            const totalDays = myRecords.length;
            const presentDays = myRecords.filter(r => r.status === 'Present').length;
            const absentDays = totalDays - presentDays;
            const percentage = totalDays > 0 ? ((presentDays / totalDays) * 100).toFixed(1) : 100;

            const rows = myRecords.map(r => `
                <tr class="border-b hover:bg-gray-50"><td class="p-3 text-sm whitespace-nowrap">${r.date}</td><td class="p-3"><span class="px-2 py-1 rounded text-xs font-bold ${r.status === 'Present' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${r.status}</span></td></tr>
            `).join('');

            return `
                <div class="max-w-4xl mx-auto space-y-6 pb-20">
                    ${getWardSwitcherHTML()}
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm text-center border-b-4 border-blue-500"><p class="text-gray-500 text-sm">Attendance</p><h3 class="text-3xl font-bold text-blue-600">${percentage}%</h3></div>
                        <div class="bg-white p-6 rounded-xl shadow-sm text-center border-b-4 border-green-500"><p class="text-gray-500 text-sm">Present Days</p><h3 class="text-3xl font-bold text-green-600">${presentDays}</h3></div>
                        <div class="bg-white p-6 rounded-xl shadow-sm text-center border-b-4 border-red-500"><p class="text-gray-500 text-sm">Absent Days</p><h3 class="text-3xl font-bold text-red-600">${absentDays}</h3></div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm overflow-hidden"><div class="p-4 border-b bg-gray-50"><h3 class="font-bold text-lg">Detailed Attendance Log</h3></div><div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-gray-100 text-gray-500 text-sm uppercase"><tr><th class="p-3">Date</th><th class="p-3">Status</th></tr></thead><tbody>${rows || '<tr><td colspan="2" class="p-4 text-center text-gray-500">No records found.</td></tr>'}</tbody></table></div></div>
                </div>
            `;
        }

        function getNoticesHTML() {
            const notices = DAO.get(DB_KEYS.NOTICES).reverse();
            const batches = DAO.get(DB_KEYS.BATCHES);
            
            let filteredNotices = notices;
            let canCreate = currentUser.role !== 'parent';

            if (currentUser.role === 'parent') {
                let studentBatchId = null;
                if (selectedWardId) {
                    const student = DAO.get(DB_KEYS.STUDENTS).find(s => s.id === selectedWardId);
                    studentBatchId = student ? student.batchId : null;
                }
                filteredNotices = notices.filter(n => n.target === 'all' || (studentBatchId && n.target === studentBatchId));
            } else if (currentUser.role === 'teacher') {
                filteredNotices = notices.filter(n => n.sender === currentUser.name || n.target === 'all');
            }

            const cards = filteredNotices.map(n => {
                let badge = n.target === 'all' ? '<span class="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded">All</span>' : `<span class="bg-purple-100 text-purple-700 text-xs px-2 py-1 rounded">Batch</span>`;
                const deleteBtn = (currentUser.role === 'admin' || (currentUser.role === 'teacher' && n.sender === currentUser.name)) ? `<button onclick="deleteNotice('${n.id}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>` : '';
                return `
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-100 hover:border-blue-200 transition">
                        <div class="flex justify-between items-start mb-2"><h4 class="font-bold text-slate-800">${n.title}</h4>${deleteBtn}</div>
                        <p class="text-slate-600 text-sm mb-3">${n.message}</p>
                        <div class="flex justify-between items-center text-xs text-gray-400"><div class="flex items-center gap-2"><i class="fas fa-user-circle"></i> ${n.sender} ${badge}</div><span>${n.date}</span></div>
                    </div>
                `;
            }).join('');

            return `
                <div class="max-w-4xl mx-auto pb-20">
                    ${canCreate ? `
                    <div class="bg-white p-4 rounded-xl shadow-sm mb-6">
                        <h3 class="font-bold text-lg mb-4">Send New Notice</h3>
                        <form onsubmit="saveNotice(event)">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <input type="text" name="title" placeholder="Notice Title" required class="border p-2 rounded w-full">
                                <select name="target" required class="border p-2 rounded w-full">
                                    ${currentUser.role === 'admin' ? '<option value="all">All Batches (Broadcast)</option>' : ''}
                                    ${batches.filter(b => currentUser.role === 'admin' || b.teacherId === currentUser.id).map(b => `<option value="${b.id}">${b.name}</option>`).join('')}
                                </select>
                            </div>
                            <textarea name="message" placeholder="Type your message here..." required class="border p-2 rounded w-full h-24 mb-4 resize-none"></textarea>
                            <div class="flex justify-end"><button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition flex items-center gap-2"><i class="fas fa-paper-plane"></i> Send</button></div>
                        </form>
                    </div>` : ''}
                    <h3 class="font-bold text-lg mb-4 text-slate-700">Notice Board</h3>
                    <div class="space-y-4">${cards.length ? cards : '<p class="text-center text-gray-400 py-8">No notices available.</p>'}</div>
                </div>
            `;
        }

        function getStudentsHTML() {
            const students = DAO.get(DB_KEYS.STUDENTS);
            const batches = DAO.get(DB_KEYS.BATCHES);
            
            let rows = students.map(s => {
                const batch = batches.find(b => b.id === s.batchId)?.name || 'Unassigned';
                return `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-4 font-medium whitespace-nowrap">${s.name}</td>
                    <td class="p-4 text-sm text-gray-600 whitespace-nowrap">${batch}</td>
                    <td class="p-4 text-sm text-gray-600 whitespace-nowrap">${s.phone}</td>
                    <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${s.paidFees >= s.totalFees ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${s.paidFees >= s.totalFees ? 'Paid' : 'Due'}</span></td>
                    <td class="p-4 flex gap-2 whitespace-nowrap">
                         <button onclick="openModal('viewStudent', '${s.id}')" class="text-teal-600 hover:bg-teal-100 p-2 rounded"><i class="fas fa-eye"></i></button>
                        <button onclick="generateIDCard('${s.id}')" class="text-blue-600 hover:bg-blue-100 p-2 rounded"><i class="fas fa-id-card"></i></button>
                        <button onclick="generateReportCard('${s.id}')" class="text-purple-600 hover:bg-purple-100 p-2 rounded"><i class="fas fa-file-alt"></i></button>
                        <button onclick="editStudent('${s.id}')" class="text-gray-600 hover:bg-gray-200 p-2 rounded"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteStudent('${s.id}')" class="text-red-600 hover:bg-red-100 p-2 rounded"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            }).join('');

            return `
                <div class="bg-white rounded-xl shadow-sm overflow-hidden pb-20">
                    <div class="p-4 border-b flex justify-between items-center bg-gray-50"><h3 class="font-bold">All Students</h3><button onclick="openModal('addStudent')" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700"><i class="fas fa-plus"></i> Add New</button></div>
                    <div class="overflow-x-auto"><table class="w-full"><thead class="bg-gray-100 text-gray-600 text-sm font-bold uppercase"><tr><th class="p-4 text-left">Name</th><th class="p-4 text-left">Batch</th><th class="p-4 text-left">Contact</th><th class="p-4 text-left">Fees</th><th class="p-4 text-left">Actions</th></tr></thead><tbody>${rows || '<tr><td colspan="5" class="p-4 text-center text-gray-500">No students found.</td></tr>'}</tbody></table></div>
                </div>
            `;
        }

        function getBatchesHTML() {
            const batches = DAO.get(DB_KEYS.BATCHES);
            return `
                <div class="bg-white rounded-xl shadow-sm p-6 pb-20">
                     <div class="flex justify-between items-center mb-6"><h3 class="font-bold text-lg">Manage Batches</h3><button onclick="openModal('addBatch')" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700"><i class="fas fa-plus"></i> Create Batch</button></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${batches.map(b => `<div class="border rounded-lg p-4 hover:shadow-md transition bg-white relative"><div class="absolute top-2 right-2 text-gray-400 cursor-pointer hover:text-red-500" onclick="deleteBatch('${b.id}')"><i class="fas fa-trash"></i></div><h4 class="font-bold text-lg text-slate-800">${b.name}</h4><p class="text-sm text-gray-500 mt-1"><i class="fas fa-clock mr-1"></i> ${b.time}</p><p class="text-sm text-gray-500 mt-1"><i class="fas fa-user-tie mr-1"></i> Teacher ID: ${DAO.get(DB_KEYS.USERS).find(u => u.id === b.teacherId)?.name || 'N/A'}</p><div class="mt-4 pt-4 border-t flex justify-between items-center text-sm"><span class="text-blue-600 font-medium">${DAO.getStudentsByBatch(b.id).length} Students</span><button class="text-gray-500 hover:text-blue-600">Edit</button></div></div>`).join('')}
                        ${!batches.length ? '<p class="text-gray-500 col-span-3 text-center">No batches created yet.</p>' : ''}
                    </div>
                </div>
            `;
        }

        function getTeachersHTML() {
            const teachers = DAO.get(DB_KEYS.USERS).filter(u => u.role === 'teacher');
            let rows = teachers.map(t => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="p-4 font-medium flex items-center gap-3 whitespace-nowrap"><div class="w-8 h-8 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center font-bold text-xs">${t.name.charAt(0)}</div>${t.name}</td>
                    <td class="p-4 text-sm text-gray-600 whitespace-nowrap">${t.phone || 'N/A'}</td>
                    <td class="p-4 text-sm text-gray-600 whitespace-nowrap">${t.username}</td>
                    <td class="p-4 text-sm text-gray-600 flex gap-2 whitespace-nowrap"><button onclick="openModal('viewTeacher', '${t.id}')" class="text-teal-600 hover:bg-teal-100 p-2 rounded"><i class="fas fa-eye"></i></button><button onclick="deleteTeacher('${t.id}')" class="text-red-600 hover:bg-red-100 p-2 rounded"><i class="fas fa-trash"></i></button></td>
                </tr>`).join('');

            return `
                <div class="bg-white rounded-xl shadow-sm overflow-hidden pb-20">
                    <div class="p-4 border-b flex justify-between items-center bg-gray-50"><h3 class="font-bold">All Teachers</h3><button onclick="openModal('addTeacher')" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700"><i class="fas fa-plus"></i> Add Teacher</button></div>
                    <div class="overflow-x-auto"><table class="w-full"><thead class="bg-gray-100 text-gray-600 text-sm font-bold uppercase"><tr><th class="p-4 text-left">Name</th><th class="p-4 text-left">Mobile</th><th class="p-4 text-left">Email ID</th><th class="p-4 text-left">Actions</th></tr></thead><tbody>${rows || '<tr><td colspan="5" class="p-4 text-center text-gray-500">No teachers found.</td></tr>'}</tbody></table></div>
                </div>`;
        }
        
        function getMarksHTML() {
            const tests = DAO.get(DB_KEYS.MARKS);
            const batches = DAO.get(DB_KEYS.BATCHES);
            const getAvg = (scores) => {
                const values = Object.values(scores || {});
                if(!values.length) return 0;
                const sum = values.reduce((a,b) => a + parseInt(b), 0);
                return Math.round(sum / values.length);
            };

            const testCards = tests.length ? tests.map(t => {
                const batchName = batches.find(b => b.id === t.batchId)?.name || 'Unknown Batch';
                const avg = getAvg(t.scores);
                return `
                    <div class="bg-white p-4 rounded-lg border hover:shadow-md transition relative group">
                        <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition flex gap-1"><button onclick="deleteTest('${t.id}')" class="text-red-500 hover:bg-red-50 p-1.5 rounded"><i class="fas fa-trash"></i></button></div>
                        <p class="text-xs text-blue-600 font-bold uppercase mb-1">${t.date}</p>
                        <h4 class="font-bold text-slate-800 truncate" title="${t.name}">${t.name}</h4>
                        <p class="text-sm text-gray-500 mt-2">${batchName}</p>
                        <div class="mt-4 flex items-center justify-between text-xs gap-2">
                            <span class="bg-gray-100 px-2 py-1 rounded border font-medium">Avg: ${avg}%</span>
                            <div class="flex gap-2"><button onclick="openModal('viewTestResult', '${t.id}')" class="text-slate-600 bg-slate-100 hover:bg-slate-200 px-2 py-1 rounded font-medium transition"><i class="fas fa-eye mr-1"></i>View</button><button onclick="openModal('manageMarks', '${t.id}')" class="text-white bg-blue-600 hover:bg-blue-700 px-2 py-1 rounded font-medium transition"><i class="fas fa-edit mr-1"></i>Edit</button></div>
                        </div>
                    </div>
                `;
            }).join('') : '<div class="col-span-3 text-center py-8 text-gray-400 italic">No tests created yet. Click "Add Test Marks" to start.</div>';

            return `
                <div class="bg-white rounded-xl shadow-sm p-6 pb-20"><div class="flex justify-between items-center mb-6"><h3 class="font-bold text-lg">Class Performance</h3><button onclick="openModal('addTest')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-sm transition shadow-sm"><i class="fas fa-plus mr-2"></i>Add Test Marks</button></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">${testCards}</div></div>
            `;
        }

        function getAttendanceHTML() {
            const batches = DAO.get(DB_KEYS.BATCHES);
            const options = batches.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
            return `
                <div class="bg-white rounded-xl shadow-sm p-6 max-w-3xl mx-auto pb-20">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div><label class="block text-sm font-medium mb-1">Select Batch</label><select id="att-batch" onchange="loadAttendanceSheet()" class="w-full border rounded p-2 bg-gray-50"><option value="">-- Select Batch --</option>${options}</select></div>
                        <div><label class="block text-sm font-medium mb-1">Date</label><input type="date" id="att-date" class="w-full border rounded p-2 bg-gray-50" value="${new Date().toISOString().split('T')[0]}"></div>
                    </div>
                    <div id="attendance-list" class="space-y-2"><p class="text-center text-gray-500 italic py-8">Select a batch to load student list.</p></div>
                    <div class="mt-6 text-right hidden" id="att-submit-btn"><button onclick="saveAttendance()" class="bg-green-600 text-white px-6 py-2 rounded-lg shadow hover:bg-green-700">Save Attendance</button></div>
                </div>
            `;
        }

        function getFeesHTML() {
            let students = DAO.get(DB_KEYS.STUDENTS);
            const isAdmin = currentUser.role === 'admin';
            const isTeacher = currentUser.role === 'teacher';

            if (isTeacher) {
                const batches = DAO.get(DB_KEYS.BATCHES);
                const myBatchIds = batches.filter(b => b.teacherId === currentUser.id).map(b => b.id);
                students = students.filter(s => myBatchIds.includes(s.batchId));
            }

            return `
                <div class="bg-white rounded-xl shadow-sm overflow-hidden pb-20">
                    <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                        <h3 class="font-bold">Fee Status ${isTeacher ? '(My Batches)' : ''}</h3>
                        <span class="text-xs text-gray-500 bg-white border px-2 py-1 rounded">Real-time Balance</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-100 text-xs uppercase font-bold text-gray-600">
                                <tr>
                                    <th class="p-4 text-left">Student</th>
                                    ${!isTeacher ? '<th class="p-4 text-left">Total</th>' : ''}
                                    ${!isTeacher ? '<th class="p-4 text-left">Paid</th>' : ''}
                                    <th class="p-4 text-left">Balance</th>
                                    <th class="p-4 text-left">Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${students.length > 0 ? students.map(s => {
                                    const balance = s.totalFees - s.paidFees;
                                    const balanceClass = balance > 0 ? 'text-red-600 font-bold' : 'text-green-600';
                                    return `
                                    <tr class="border-b hover:bg-gray-50">
                                        <td class="p-4 font-medium whitespace-nowrap">${s.name}<div class="text-xs text-gray-400">ID: ${s.id}</div></td>
                                        ${!isTeacher ? `<td class="p-4 whitespace-nowrap">â‚¹${s.totalFees}</td>` : ''}
                                        ${!isTeacher ? `<td class="p-4 whitespace-nowrap text-green-600 font-bold">â‚¹${s.paidFees}</td>` : ''}
                                        <td class="p-4 ${balanceClass} whitespace-nowrap">â‚¹${balance}</td>
                                        <td class="p-4 flex gap-2 whitespace-nowrap">
                                            ${isAdmin ? `<button onclick="openModal('updateFee', '${s.id}')" class="text-xs bg-green-100 text-green-700 px-3 py-1.5 rounded hover:bg-green-200 font-bold border border-green-200 shadow-sm transition"><i class="fas fa-plus mr-1"></i> Pay</button>` : ''}
                                            <button onclick="viewFeeHistory('${s.id}')" class="text-xs bg-gray-100 text-gray-600 px-3 py-1.5 rounded hover:bg-gray-200 border border-gray-200 shadow-sm transition"><i class="fas fa-history mr-1"></i></button>
                                        </td>
                                    </tr>
                                `}).join('') : '<tr><td colspan="5" class="p-6 text-center text-gray-500 italic">No students found.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // ==========================================
        // HELPER LOGIC FOR SEARCH & MODALS
        // ==========================================

        function performSearch(query) {
            const content = document.getElementById('content-area');
            const title = document.getElementById('page-title');
            title.innerText = 'Search Results';

            if (!query.trim()) {
                renderView('dashboard');
                return;
            }

            query = query.toLowerCase();
            const students = DAO.get(DB_KEYS.STUDENTS).filter(s => s.name.toLowerCase().includes(query) || s.phone.includes(query));
            const teachers = DAO.get(DB_KEYS.USERS).filter(u => u.role === 'teacher' && (u.name.toLowerCase().includes(query) || (u.username && u.username.toLowerCase().includes(query))));

            let html = `<div class="space-y-6 pb-20">`;

            if (students.length > 0) {
                html += `<div><h3 class="text-sm font-bold uppercase text-gray-500 mb-3 border-b pb-1">Students (${students.length})</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${students.map(s => `<div class="bg-white p-4 rounded-lg shadow-sm border flex justify-between items-center"><div><p class="font-bold text-slate-800">${s.name}</p><p class="text-xs text-gray-500">${s.phone}</p></div><button onclick="openModal('viewStudent', '${s.id}')" class="text-blue-600 bg-blue-50 p-2 rounded-full"><i class="fas fa-eye"></i></button></div>`).join('')}</div></div>`;
            }

            if (teachers.length > 0) {
                html += `<div><h3 class="text-sm font-bold uppercase text-gray-500 mb-3 border-b pb-1">Teachers (${teachers.length})</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${teachers.map(t => `<div class="bg-white p-4 rounded-lg shadow-sm border flex justify-between items-center"><div><p class="font-bold text-slate-800">${t.name}</p><p class="text-xs text-gray-500">${t.username}</p></div><button onclick="openModal('viewTeacher', '${t.id}')" class="text-purple-600 bg-purple-50 p-2 rounded-full"><i class="fas fa-eye"></i></button></div>`).join('')}</div></div>`;
            }

            if (students.length === 0 && teachers.length === 0) {
                html += `<div class="text-center py-10 text-gray-400">No results found for "${query}"</div>`;
            }

            html += `</div>`;
            content.innerHTML = html;
        }

        // --- Modals, Forms & Actions ---
        
        function showToast(msg, type = 'info') { const container = document.getElementById('toast-container'); const toast = document.createElement('div'); const colors = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-green-500' : 'bg-blue-600'; toast.className = `${colors} text-white px-6 py-3 rounded shadow-lg flex items-center gap-3 fade-in transform transition-all duration-500`; toast.innerHTML = `<i class="fas fa-${type === 'error' ? 'exclamation-circle' : 'check-circle'}"></i> <span>${msg}</span>`; container.appendChild(toast); setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 500); }, 3000); }
        function showNotifications() { renderView('notices'); }
        function forgotPassword() { const modal = document.getElementById('modal-container'); modal.classList.remove('hidden'); modal.innerHTML = `<div class="bg-white rounded-lg p-6 w-full max-w-sm text-center"><div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600 text-2xl"><i class="fas fa-lock"></i></div><h3 class="text-xl font-bold mb-2 text-slate-800">Forgot Password?</h3><p class="text-gray-600 mb-6 text-sm">Please contact the School Administration.</p><div class="bg-gray-50 p-3 rounded text-sm mb-6 border border-gray-200"><p class="font-bold text-slate-700">Admin Contact:</p><p class="text-blue-600 font-medium">9834338813</p></div><button onclick="closeModal()" class="w-full bg-slate-800 text-white px-4 py-2 rounded-lg hover:bg-slate-900">Close</button></div>`; }
        function saveNotice(e) { e.preventDefault(); const form = e.target; const notices = DAO.get(DB_KEYS.NOTICES); notices.push({ id: 'n'+Date.now(), title: form.title.value, message: form.message.value, target: form.target.value, sender: currentUser.name, date: new Date().toISOString().split('T')[0] }); DAO.set(DB_KEYS.NOTICES, notices); showToast('Notice sent!', 'success'); updateMarquee(); renderView('notices'); }
        function deleteNotice(id) { if(confirm('Delete?')) { let notices = DAO.get(DB_KEYS.NOTICES).filter(n=>n.id!==id); DAO.set(DB_KEYS.NOTICES, notices); updateMarquee(); renderView('notices'); showToast('Deleted', 'success'); } }
        function saveAttendance() { const batchId = document.getElementById('att-batch').value; const date = document.getElementById('att-date').value; if(!batchId || !date) return showToast('Select batch & date', 'error'); const records = {}; document.querySelectorAll('.att-checkbox').forEach(cb => records[cb.value] = cb.checked ? 'Present' : 'Absent'); let db = DAO.get(DB_KEYS.ATTENDANCE); const idx = db.findIndex(r => r.date === date && r.batchId === batchId); if(idx !== -1) db[idx].records = records; else db.push({date, batchId, records}); DAO.set(DB_KEYS.ATTENDANCE, db); showToast('Saved', 'success'); }
        function editStudent(id) { openModal('editStudent', id); }
        function updatePassword(e) { e.preventDefault(); const f = e.target; if(f.currentPass.value !== currentUser.password) return showToast('Wrong password', 'error'); if(f.newPass.value !== f.confirmPass.value) return showToast('Mismatch', 'error'); let users = DAO.get(DB_KEYS.USERS); users.find(u=>u.id===currentUser.id).password = f.newPass.value; DAO.set(DB_KEYS.USERS, users); currentUser.password = f.newPass.value; sessionStorage.setItem(DB_KEYS.CURRENT_USER, JSON.stringify(currentUser)); closeModal(); showToast('Password Updated', 'success'); }
        function updateStudent(e, id) { e.preventDefault(); const f = e.target; let db = DAO.get(DB_KEYS.STUDENTS); const idx = db.findIndex(s=>s.id===id); if(idx!==-1) { db[idx] = {...db[idx], name:f.name.value, phone:f.phone.value, dob:f.dob.value, batchId:f.batchId.value, totalFees: parseInt(f.totalFees.value)}; DAO.set(DB_KEYS.STUDENTS, db); closeModal(); showToast('Updated', 'success'); renderView('students'); } }
        function closeModal() { document.getElementById('modal-container').classList.add('hidden'); }
        function uploadPhoto(input, id) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { const students = DAO.get(DB_KEYS.STUDENTS); const idx = students.findIndex(s => s.id === id); if(idx !== -1) { students[idx].photo = e.target.result; DAO.set(DB_KEYS.STUDENTS, students); showToast('Photo uploaded!', 'success'); renderView('my-child'); } }; reader.readAsDataURL(input.files[0]); } }
        function toggleSidebar() { const sidebar = document.getElementById('sidebar'); const overlay = document.getElementById('sidebar-overlay'); sidebar.classList.toggle('hidden'); overlay.classList.toggle('hidden'); }
        function generateIDCard(id) { const student = DAO.get(DB_KEYS.STUDENTS).find(s => s.id === id); if(!student) return; const modal = document.getElementById('modal-container'); modal.classList.remove('hidden'); modal.innerHTML = `<div class="bg-white p-4 rounded-xl max-w-sm w-full"><div id="printable-area" class="id-card-bg text-white rounded-xl shadow-2xl p-6 text-center w-full max-w-[350px] mx-auto h-[500px] flex flex-col items-center justify-between border border-slate-700"><div class="w-full"><h2 class="text-xl font-bold tracking-widest uppercase mb-1">APPS Education</h2><p class="text-xs text-blue-200">Excellence in Coaching</p></div><div class="relative w-32 h-32 rounded-full border-4 border-white/20 bg-white/10 overflow-hidden flex items-center justify-center">${student.photo ? `<img src="${student.photo}" class="w-full h-full object-cover">` : '<i class="fas fa-user text-5xl text-white/50"></i>'}</div><div class="w-full"><h1 class="text-2xl font-bold mb-1">${student.name}</h1><p class="text-blue-300 font-medium mb-4">Student</p><div class="bg-white/10 rounded-lg p-3 text-sm text-left space-y-2"><div class="flex justify-between border-b border-white/10 pb-1"><span>ID No:</span> <span class="font-mono">${student.id}</span></div><div class="flex justify-between border-b border-white/10 pb-1"><span>Batch:</span> <span>${student.batchId}</span></div><div class="flex justify-between border-b border-white/10 pb-1"><span>DOB:</span> <span>${student.dob || 'N/A'}</span></div><div class="flex justify-between"><span>Phone:</span> <span>${student.phone}</span></div></div></div><div class="w-full pt-4 border-t border-white/10"><p class="text-[10px] text-white/50">www.appseducation.com</p><div class="mt-2 w-full h-8 bg-white/90 rounded overflow-hidden flex items-center justify-center"><span class="text-black text-xs font-mono tracking-[4px]">*${student.id}*</span></div></div></div><div class="mt-4 flex gap-2 justify-center no-print"><button onclick="window.print()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"><i class="fas fa-print"></i> Print</button><button onclick="closeModal()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300">Close</button></div></div>`; }
        function generateReportCard(id) { const student = DAO.get(DB_KEYS.STUDENTS).find(s => s.id === id); const batch = DAO.get(DB_KEYS.BATCHES).find(b => b.id === student.batchId); if(!student) return; const mockMarks = [{ subject: 'Mathematics', max: 100, obt: 85, grade: 'A' }, { subject: 'Physics', max: 100, obt: 78, grade: 'B+' }, { subject: 'Chemistry', max: 100, obt: 82, grade: 'A' }, { subject: 'English', max: 100, obt: 90, grade: 'A+' }, { subject: 'Computer Sci', max: 100, obt: 95, grade: 'O' }]; const totalMax = mockMarks.reduce((a, b) => a + b.max, 0); const totalObt = mockMarks.reduce((a, b) => a + b.obt, 0); const percentage = ((totalObt / totalMax) * 100).toFixed(2); const modal = document.getElementById('modal-container'); modal.classList.remove('hidden'); modal.innerHTML = `<div class="bg-gray-100 overflow-y-auto max-h-screen p-4 w-full flex justify-center"><div id="printable-area" class="a4-page shadow-2xl text-slate-900 relative"><div class="border-b-4 border-blue-900 pb-6 mb-8 flex justify-between items-end"><div><h1 class="text-4xl font-bold text-blue-900 uppercase tracking-wider">APPS Education</h1><p class="text-sm text-gray-600 mt-1">123, Knowledge Park, Education City, India</p><p class="text-sm text-gray-600">Phone: +91 98765 43210 | Email: info@appseducation.com</p></div><div class="text-right"><h2 class="text-2xl font-bold text-gray-400 uppercase">Report Card</h2><p class="text-sm font-bold text-slate-800 mt-1">Academic Year: 2023-24</p></div></div><div class="flex gap-8 mb-8 bg-blue-50 p-6 rounded-lg border border-blue-100"><div class="w-32 h-32 bg-white border-2 border-blue-200 rounded-lg flex items-center justify-center overflow-hidden">${student.photo ? `<img src="${student.photo}" class="w-full h-full object-cover">` : '<i class="fas fa-user text-4xl text-blue-200"></i>'}</div><div class="flex-1 grid grid-cols-2 gap-y-4 gap-x-8 text-sm"><div><p class="text-gray-500 uppercase text-xs font-bold">Student Name</p><p class="font-bold text-lg">${student.name}</p></div><div><p class="text-gray-500 uppercase text-xs font-bold">Student ID</p><p class="font-bold text-lg font-mono">${student.id}</p></div><div><p class="text-gray-500 uppercase text-xs font-bold">Batch / Class</p><p class="font-bold text-lg">${batch ? batch.name : 'N/A'}</p></div><div><p class="text-gray-500 uppercase text-xs font-bold">Parent Contact</p><p class="font-bold text-lg">${student.phone}</p></div><div><p class="text-gray-500 uppercase text-xs font-bold">Date of Birth</p><p class="font-bold text-lg">${student.dob || 'N/A'}</p></div></div></div><div class="mb-8"><h3 class="font-bold text-lg border-b-2 border-gray-800 mb-4 pb-1 uppercase">Academic Performance</h3><table class="w-full text-left border-collapse"><thead><tr class="bg-gray-800 text-white text-sm uppercase"><th class="p-3 border border-gray-800">Subject</th><th class="p-3 border border-gray-800 text-center">Max Marks</th><th class="p-3 border border-gray-800 text-center">Obtained</th><th class="p-3 border border-gray-800 text-center">Grade</th></tr></thead><tbody class="text-sm">${mockMarks.map(m => `<tr><td class="p-3 border border-gray-300 font-medium">${m.subject}</td><td class="p-3 border border-gray-300 text-center">${m.max}</td><td class="p-3 border border-gray-300 text-center font-bold">${m.obt}</td><td class="p-3 border border-gray-300 text-center">${m.grade}</td></tr>`).join('')}<tr class="bg-gray-100 font-bold"><td class="p-3 border border-gray-300 text-right">TOTAL</td><td class="p-3 border border-gray-300 text-center">${totalMax}</td><td class="p-3 border border-gray-300 text-center text-blue-900 text-lg">${totalObt}</td><td class="p-3 border border-gray-300 text-center">${percentage}%</td></tr></tbody></table></div><div class="mt-auto"><div class="flex justify-between items-start gap-8 mb-16"><div class="w-2/3"><h3 class="font-bold text-sm uppercase mb-2">Remarks</h3><p class="text-sm italic text-gray-600 border p-3 rounded bg-gray-50">Excellent performance. Keep it up!</p></div><div class="w-1/3 text-center"><h3 class="font-bold text-sm uppercase mb-2">Final Result</h3><div class="bg-green-100 text-green-800 border border-green-200 font-bold text-xl py-3 rounded">PASS</div></div></div><div class="flex justify-between items-end pt-8 border-t border-gray-300"><div class="text-center w-40"><div class="mb-2 h-10"></div><p class="border-t border-gray-400 pt-1 text-xs font-bold uppercase">Class Teacher</p></div><div class="text-center w-40"><div class="mb-2 h-10"></div><p class="border-t border-gray-400 pt-1 text-xs font-bold uppercase">Principal Signature</p></div><div class="text-center w-40"><div class="mb-2 h-10"></div><p class="border-t border-gray-400 pt-1 text-xs font-bold uppercase">Parent Signature</p></div></div><p class="text-center text-[10px] text-gray-400 mt-8">Generated by APPS Education Management System on ${new Date().toLocaleDateString()}</p></div></div><div class="fixed bottom-8 right-8 flex flex-col gap-2 no-print"><button onclick="window.print()" class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-lg transition transform hover:scale-110"><i class="fas fa-print text-xl"></i></button><button onclick="closeModal()" class="bg-gray-600 hover:bg-gray-700 text-white p-4 rounded-full shadow-lg transition transform hover:scale-110"><i class="fas fa-times text-xl"></i></button></div></div>`; }

        // Re-injecting openModal and its lengthy content to ensure full functionality
        function openModal(type, id = null) {
            const modal = document.getElementById('modal-container');
            modal.classList.remove('hidden');
            let content = '';

            if (type === 'addStudent') {
                content = `<div class="bg-white rounded-lg p-6 w-full max-w-md max-h-[90vh] overflow-y-auto"><h3 class="text-xl font-bold mb-4">Add New Student</h3><form onsubmit="saveStudent(event)"><h4 class="text-sm font-bold text-blue-600 mb-2 uppercase border-b pb-1">Student Details</h4><input type="text" name="name" placeholder="Full Name" required class="w-full border p-2 rounded mb-3"><input type="tel" name="phone" placeholder="Phone" required class="w-full border p-2 rounded mb-3"><div class="grid grid-cols-2 gap-3 mb-3"><div><label class="block text-xs text-gray-500 mb-1">Date of Birth</label><input type="date" name="dob" required class="w-full border p-2 rounded"></div><div><label class="block text-xs text-gray-500 mb-1">Batch</label><select name="batchId" class="w-full border p-2 rounded"><option value="">Select Batch</option>${DAO.get(DB_KEYS.BATCHES).map(b => `<option value="${b.id}">${b.name}</option>`).join('')}</select></div></div><input type="number" name="totalFees" placeholder="Total Fees Amount" required class="w-full border p-2 rounded mb-4"><div class="bg-gray-50 p-3 rounded border border-gray-200 mb-4"><h4 class="text-sm font-bold text-green-600 mb-2 uppercase flex items-center gap-2"><i class="fas fa-user-lock"></i> Create Parent Login</h4><input type="email" name="parentUsername" placeholder="Parent Email ID" required class="w-full border p-2 rounded mb-2 bg-white"><input type="password" name="parentPassword" placeholder="Set Password" required class="w-full border p-2 rounded bg-white"></div><div class="flex justify-end gap-2 mt-4"><button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-600">Cancel</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 shadow-md">Save Student & Login</button></div></form></div>`;
            } else if (type === 'addTeacher') {
                content = `<div class="bg-white rounded-lg p-6 w-full max-w-md"><h3 class="text-xl font-bold mb-4">Add New Teacher</h3><form onsubmit="saveTeacher(event)"><h4 class="text-sm font-bold text-blue-600 mb-2 uppercase border-b pb-1">Personal Info</h4><input type="text" name="name" placeholder="Full Name" required class="w-full border p-2 rounded mb-3"><input type="tel" name="phone" placeholder="Mobile Number" required class="w-full border p-2 rounded mb-3"><label class="block text-xs text-gray-500 mb-1">Date of Birth</label><input type="date" name="dob" required class="w-full border p-2 rounded mb-4"><div class="bg-gray-50 p-3 rounded border border-gray-200 mb-4"><h4 class="text-sm font-bold text-purple-600 mb-2 uppercase flex items-center gap-2"><i class="fas fa-key"></i> Create Login</h4><input type="email" name="username" placeholder="Login Email ID" required class="w-full border p-2 rounded mb-2 bg-white"><input type="password" name="password" placeholder="Password" required class="w-full border p-2 rounded bg-white"></div><div class="flex justify-end gap-2 mt-4"><button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-600">Cancel</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Add Teacher</button></div></form></div>`;
            } else if (type === 'editStudent') {
                const student = DAO.get(DB_KEYS.STUDENTS).find(s => s.id === id);
                if (!student) return;
                content = `<div class="bg-white rounded-lg p-6 w-full max-w-md"><h3 class="text-xl font-bold mb-4">Edit Student</h3><form onsubmit="updateStudent(event, '${id}')"><input type="text" name="name" placeholder="Full Name" value="${student.name}" required class="w-full border p-2 rounded mb-3"><input type="tel" name="phone" placeholder="Phone" value="${student.phone}" required class="w-full border p-2 rounded mb-3"><label class="block text-xs text-gray-500 mb-1">Date of Birth</label><input type="date" name="dob" value="${student.dob}" required class="w-full border p-2 rounded mb-3"><select name="batchId" class="w-full border p-2 rounded mb-3"><option value="">Select Batch</option>${DAO.get(DB_KEYS.BATCHES).map(b => `<option value="${b.id}" ${b.id === student.batchId ? 'selected' : ''}>${b.name}</option>`).join('')}</select><input type="number" name="totalFees" placeholder="Total Fees" value="${student.totalFees}" required class="w-full border p-2 rounded mb-3"><div class="flex justify-end gap-2 mt-4"><button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-600">Cancel</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Update</button></div></form></div>`;
            } else if (type === 'viewStudent') {
                const student = DAO.get(DB_KEYS.STUDENTS).find(s => s.id === id);
                const batch = DAO.get(DB_KEYS.BATCHES).find(b => b.id === student.batchId);
                const parentUser = DAO.get(DB_KEYS.USERS).find(u => u.studentId === student.id && u.role === 'parent');
                content = `<div class="bg-white rounded-lg p-0 w-full max-w-lg overflow-hidden relative"><div class="h-24 bg-gradient-to-r from-blue-500 to-purple-500"></div><div class="px-6 pb-6"><div class="flex justify-between items-end -mt-10 mb-4"><div class="w-20 h-20 rounded-full border-4 border-white bg-gray-200 overflow-hidden">${student.photo ? `<img src="${student.photo}" class="w-full h-full object-cover">` : '<i class="fas fa-user text-3xl text-gray-400 w-full h-full flex items-center justify-center"></i>'}</div><button onclick="closeModal()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button></div><h2 class="text-2xl font-bold text-slate-800">${student.name}</h2><p class="text-blue-600 font-medium text-sm">Student | ${batch ? batch.name : 'No Batch'}</p><div class="mt-6 grid grid-cols-2 gap-4"><div class="bg-gray-50 p-3 rounded"><p class="text-xs text-gray-500 uppercase">Mobile</p><p class="font-medium">${student.phone}</p></div><div class="bg-gray-50 p-3 rounded"><p class="text-xs text-gray-500 uppercase">Date of Birth</p><p class="font-medium">${student.dob || 'Not Set'}</p></div><div class="bg-gray-50 p-3 rounded"><p class="text-xs text-gray-500 uppercase">Total Fees</p><p class="font-medium">â‚¹${student.totalFees}</p></div><div class="bg-gray-50 p-3 rounded"><p class="text-xs text-gray-500 uppercase">Paid Fees</p><p class="font-medium text-green-600">â‚¹${student.paidFees}</p></div></div><div class="mt-4 border-t pt-4"><h4 class="text-sm font-bold text-gray-700 mb-2 flex items-center gap-2"><i class="fas fa-key text-yellow-500"></i> Parent Login Credentials</h4>${parentUser ? `<div class="grid grid-cols-2 gap-4"><div class="bg-yellow-50 p-3 rounded border border-yellow-100"><p class="text-xs text-gray-500 uppercase">Email ID</p><p class="font-mono font-medium text-slate-800 text-xs break-all">${parentUser.username}</p></div><div class="bg-yellow-50 p-3 rounded border border-yellow-100"><p class="text-xs text-gray-500 uppercase">Password</p><p class="font-mono font-medium text-slate-800">${parentUser.password}</p></div></div>` : `<div class="bg-red-50 p-3 rounded border border-red-100 text-red-600 text-sm">No parent account linked yet.</div>`}</div></div></div>`;
            } else if (type === 'viewTeacher') {
                const teacher = DAO.get(DB_KEYS.USERS).find(t => t.id === id);
                content = `<div class="bg-white rounded-lg p-0 w-full max-w-lg overflow-hidden relative"><div class="h-24 bg-gradient-to-r from-purple-500 to-pink-500"></div><div class="px-6 pb-6"><div class="flex justify-between items-end -mt-10 mb-4"><div class="w-20 h-20 rounded-full border-4 border-white bg-purple-100 flex items-center justify-center text-3xl text-purple-600 font-bold">${teacher.name.charAt(0)}</div><button onclick="closeModal()" class="text-gray-500 hover:text-gray-700"><i class="fas fa-times text-xl"></i></button></div><h2 class="text-2xl font-bold text-slate-800">${teacher.name}</h2><p class="text-purple-600 font-medium text-sm">Teacher | Faculty</p><div class="mt-6 grid grid-cols-2 gap-4"><div class="bg-gray-50 p-3 rounded"><p class="text-xs text-gray-500 uppercase">Mobile</p><p class="font-medium">${teacher.phone || 'N/A'}</p></div><div class="bg-gray-50 p-3 rounded"><p class="text-xs text-gray-500 uppercase">Date of Birth</p><p class="font-medium">${teacher.dob || 'Not Set'}</p></div><div class="bg-gray-50 p-3 rounded"><p class="text-xs text-gray-500 uppercase">Status</p><p class="font-medium text-green-600">Active</p></div></div><div class="mt-4 border-t pt-4"><h4 class="text-sm font-bold text-gray-700 mb-2 flex items-center gap-2"><i class="fas fa-id-badge text-purple-500"></i> Login Credentials</h4><div class="grid grid-cols-2 gap-4"><div class="bg-purple-50 p-3 rounded border border-purple-100"><p class="text-xs text-gray-500 uppercase">Email ID</p><p class="font-mono font-medium text-slate-800 text-xs break-all">${teacher.username}</p></div><div class="bg-purple-50 p-3 rounded border border-purple-100"><p class="text-xs text-gray-500 uppercase">Password</p><p class="font-mono font-medium text-slate-800">${teacher.password}</p></div></div></div></div></div>`;
            } else if (type === 'changePassword') {
                content = `<div class="bg-white rounded-lg p-6 w-full max-w-md"><h3 class="text-xl font-bold mb-4">Change Password</h3><form onsubmit="updatePassword(event)"><label class="block text-xs text-gray-500 mb-1">Current Password</label><input type="password" name="currentPass" placeholder="Enter current password" required class="w-full border p-2 rounded mb-3"><label class="block text-xs text-gray-500 mb-1">New Password</label><input type="password" name="newPass" placeholder="Enter new password" required class="w-full border p-2 rounded mb-3"><label class="block text-xs text-gray-500 mb-1">Confirm New Password</label><input type="password" name="confirmPass" placeholder="Confirm new password" required class="w-full border p-2 rounded mb-3"><div class="flex justify-end gap-2 mt-4"><button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-600">Cancel</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Change Password</button></div></form></div>`;
            } else if (type === 'updateFee') {
                const student = DAO.get(DB_KEYS.STUDENTS).find(s => s.id === id);
                const balance = student.totalFees - student.paidFees;
                const today = new Date().toISOString().split('T')[0];
                content = `<div class="bg-white rounded-lg p-6 w-full max-w-md"><h3 class="text-xl font-bold mb-1">Update Fees</h3><p class="text-sm text-gray-500 mb-4">For: ${student.name}</p><div class="bg-blue-50 p-3 rounded mb-4 text-sm flex justify-between"><span>Current Balance:</span><span class="font-bold text-red-600">â‚¹${balance}</span></div><form onsubmit="saveFee(event, '${id}')"><label class="block text-sm font-medium mb-1">Payment Date</label><input type="date" name="date" required class="w-full border p-2 rounded mb-3" value="${today}"><label class="block text-sm font-medium mb-1">Payment Amount</label><input type="number" name="amount" placeholder="Enter Amount" max="${balance}" required class="w-full border p-2 rounded mb-3 text-lg font-bold text-green-700"><div class="flex justify-end gap-2 mt-4"><button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-600">Cancel</button><button type="submit" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Record Payment</button></div></form></div>`;
            } else if (type === 'feeHistory') {
                const student = DAO.get(DB_KEYS.STUDENTS).find(s => s.id === id);
                const history = student.feeHistory || [];
                const rows = history.map(h => `<tr class="border-b"><td class="p-2">${h.date}</td><td class="p-2 font-bold text-green-600">â‚¹${h.amount}</td></tr>`).join('');
                content = `<div class="bg-white rounded-lg p-6 w-full max-w-sm"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Payment History</h3><button onclick="closeModal()" class="text-gray-500"><i class="fas fa-times"></i></button></div><p class="text-sm text-gray-500 mb-2">Student: ${student.name}</p><div class="max-h-60 overflow-y-auto border rounded"><table class="w-full text-sm text-left"><thead class="bg-gray-100"><tr><th class="p-2">Date</th><th class="p-2">Amount</th></tr></thead><tbody>${rows || '<tr><td colspan="2" class="p-4 text-center text-gray-400">No history found</td></tr>'}</tbody></table></div></div>`;
            } else if (type === 'addBatch') {
                content = `<div class="bg-white rounded-lg p-6 w-full max-w-md"><h3 class="text-xl font-bold mb-4">Create Batch</h3><form onsubmit="saveBatch(event)"><input type="text" name="name" placeholder="Batch Name (e.g. Class 10 Math)" required class="w-full border p-2 rounded mb-3"><input type="time" name="time" required class="w-full border p-2 rounded mb-3"><select name="teacherId" class="w-full border p-2 rounded mb-3"><option value="">Select Teacher</option>${DAO.get(DB_KEYS.USERS).filter(u => u.role === 'teacher').map(t => `<option value="${t.id}">${t.name}</option>`).join('')}</select><div class="flex justify-end gap-2 mt-4"><button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-600">Cancel</button><button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">Create</button></div></form></div>`;
            } else if (type === 'addTest') {
                content = `<div class="bg-white rounded-lg p-6 w-full max-w-md"><h3 class="text-xl font-bold mb-4">Create New Test</h3><form onsubmit="saveTest(event)"><label class="block text-xs text-gray-500 mb-1">Select Batch</label><select name="batchId" required class="w-full border p-2 rounded mb-3"><option value="">-- Select --</option>${DAO.get(DB_KEYS.BATCHES).map(b => `<option value="${b.id}">${b.name}</option>`).join('')}</select><label class="block text-xs text-gray-500 mb-1">Test Name (Subject)</label><input type="text" name="name" placeholder="e.g. Math Unit Test 1" required class="w-full border p-2 rounded mb-3"><label class="block text-xs text-gray-500 mb-1">Max Marks</label><input type="number" name="maxMarks" value="100" required class="w-full border p-2 rounded mb-3"><label class="block text-xs text-gray-500 mb-1">Date</label><input type="date" name="date" required value="${new Date().toISOString().split('T')[0]}" class="w-full border p-2 rounded mb-3"><div class="flex justify-end gap-2 mt-4"><button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-600">Cancel</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Create</button></div></form></div>`;
            } else if (type === 'viewTestResult') {
                const test = DAO.get(DB_KEYS.MARKS).find(t => t.id === id);
                const students = DAO.getStudentsByBatch(test.batchId);
                const scores = test.scores || {};
                const rankedStudents = students.map(s => ({...s, score: parseInt(scores[s.id] || 0)})).sort((a, b) => b.score - a.score);
                const rows = rankedStudents.length ? rankedStudents.map((s, index) => {const percentage = ((s.score / test.maxMarks) * 100).toFixed(1); let rankBadge = ''; if(index === 0 && s.score > 0) rankBadge = '<i class="fas fa-crown text-yellow-500 ml-2"></i>'; return `<tr class="border-b last:border-0 hover:bg-gray-50"><td class="p-3 text-sm font-bold text-gray-500">#${index + 1}</td><td class="p-3 text-sm font-medium">${s.name} ${rankBadge}</td><td class="p-3 text-sm font-bold text-right">${s.score} <span class="text-gray-400 font-normal">/ ${test.maxMarks}</span></td><td class="p-3 text-sm text-right text-gray-500">${percentage}%</td></tr>`}).join('') : '<tr><td colspan="4" class="p-4 text-center text-gray-500">No data available.</td></tr>';
                content = `<div class="bg-white rounded-lg p-6 w-full max-w-lg"><div class="flex justify-between items-center mb-4"><div><h3 class="text-xl font-bold">${test.name}</h3><p class="text-sm text-gray-500">Result Sheet â€¢ ${test.date}</p></div><button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button></div><div class="max-h-[400px] overflow-y-auto border rounded mb-4"><table class="w-full text-left"><thead class="bg-gray-50 text-xs uppercase text-gray-500 sticky top-0"><tr><th class="p-3 w-16">Rank</th><th class="p-3">Student</th><th class="p-3 text-right">Marks</th><th class="p-3 text-right">%</th></tr></thead><tbody>${rows}</tbody></table></div><div class="flex justify-end gap-2"><button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-600">Close</button><button onclick="openModal('manageMarks', '${test.id}')" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"><i class="fas fa-edit mr-1"></i> Edit Marks</button></div></div>`;
            } else if (type === 'manageMarks') {
                const test = DAO.get(DB_KEYS.MARKS).find(t => t.id === id);
                const students = DAO.getStudentsByBatch(test.batchId);
                const scores = test.scores || {};
                const rows = students.length ? students.map(s => `<tr class="border-b"><td class="p-3 text-sm font-medium">${s.name}</td><td class="p-3"><input type="number" max="${test.maxMarks}" min="0" class="border rounded w-20 p-1 text-center mark-input focus:ring-2 focus:ring-blue-500 outline-none" data-student-id="${s.id}" value="${scores[s.id] || ''}" placeholder="-"><span class="text-gray-400 text-xs">/${test.maxMarks}</span></td></tr>`).join('') : '<tr><td colspan="2" class="p-4 text-center text-gray-500">No students in this batch.</td></tr>';
                content = `<div class="bg-white rounded-lg p-6 w-full max-w-lg"><div class="flex justify-between items-center mb-4"><div><h3 class="text-xl font-bold">${test.name}</h3><p class="text-sm text-gray-500">Max Marks: ${test.maxMarks}</p></div><button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button></div><div class="max-h-[300px] overflow-y-auto border rounded mb-4"><table class="w-full text-left"><thead class="bg-gray-50 text-xs uppercase text-gray-500 sticky top-0"><tr><th class="p-3">Student</th><th class="p-3">Marks Obtained</th></tr></thead><tbody>${rows}</tbody></table></div><div class="flex justify-end gap-2"><button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-600">Cancel</button><button onclick="saveMarks('${test.id}')" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Save Marks</button></div></div>`;
            }

            modal.innerHTML = content;
        }

        const observer = new MutationObserver(function(mutations) {
            const chartCanvas = document.getElementById('performanceChart');
            if (chartCanvas && !currentChart) {
                 if(window.myBarChart) window.myBarChart.destroy();
                 let labels = ['Test 1', 'Test 2', 'Test 3'], dataPoints = [0, 0, 0];
                 if (currentUser && currentUser.role === 'parent' && selectedWardId) {
                     const allTests = DAO.get(DB_KEYS.MARKS);
                     const myResults = allTests.filter(t => t.scores && t.scores[selectedWardId]).map(t => ({ name: t.name, date: t.date, percentage: (parseInt(t.scores[selectedWardId]) / t.maxMarks * 100) })).sort((a,b) => new Date(a.date) - new Date(b.date)); 
                    if (myResults.length > 0) { labels = myResults.map(r => r.name.length > 15 ? r.name.substring(0,12) + '...' : r.name); dataPoints = myResults.map(r => r.percentage); }
                 }
                 const ctx = chartCanvas.getContext('2d');
                 window.myBarChart = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Performance (%)', data: dataPoints, backgroundColor: 'rgba(59, 130, 246, 0.2)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 2, tension: 0.3, fill: true }] }, options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } } });
                currentChart = true; 
            } else if (!chartCanvas) currentChart = false;
        });
        observer.observe(document.getElementById('content-area'), { childList: true, subtree: true });

        initApp();

    </script>
</body>
</html>